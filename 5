import ccxt
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy.signal import argrelextrema

# Initialize Binance API (Public Data Only)
exchange = ccxt.binance()

# Fetch 4-hour OHLCV data for BTC/USDT
symbol = 'BTC/USDT'
timeframe = '4h'
limit = 500  # Number of candles to fetch

ohlcv = exchange.fetch_ohlcv(symbol, timeframe, limit=limit)
df = pd.DataFrame(ohlcv, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')

# Identify Swing Highs and Lows (Using Local Extrema)
window = 5  # Sensitivity of trend detection
df['swing_high'] = np.nan
df['swing_low'] = np.nan

high_idxs = argrelextrema(df['high'].values, np.greater, order=window)[0]
low_idxs = argrelextrema(df['low'].values, np.less, order=window)[0]

df.loc[high_idxs, 'swing_high'] = df['high'].iloc[high_idxs]
df.loc[low_idxs, 'swing_low'] = df['low'].iloc[low_idxs]

# Plot Trend Lines
plt.figure(figsize=(12, 6))
plt.plot(df['timestamp'], df['close'], label='Close Price', color='black', linewidth=1)

# Plot Swing Highs and Lows
plt.scatter(df['timestamp'], df['swing_high'], color='red', label='Swing Highs', marker='^')
plt.scatter(df['timestamp'], df['swing_low'], color='green', label='Swing Lows', marker='v')

plt.title(f'Trend Line Detection - {symbol}')
plt.xlabel('Date')
plt.ylabel('Price')
plt.legend()
plt.xticks(rotation=45)
plt.grid()

# Save and display the plot
plot_path = "trend_lines.png"
plt.savefig(plot_path)
plt.show()