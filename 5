import ccxt
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import requests
from scipy.signal import argrelextrema

# ‚úÖ 1Ô∏è‚É£ Initialize Binance API (Public Data Only)
exchange = ccxt.binance()
symbol = 'BTC/USDT'
timeframe = '4h'
limit = 500  # Fetch last 500 candles

ohlcv = exchange.fetch_ohlcv(symbol, timeframe, limit=limit)
df = pd.DataFrame(ohlcv, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')

# ‚úÖ 2Ô∏è‚É£ Identify Swing Highs and Lows (Using Local Extrema)
window = 5  # Sensitivity of trend detection
df['swing_high'] = np.nan
df['swing_low'] = np.nan

high_idxs = argrelextrema(df['high'].values, np.greater, order=window)[0]
low_idxs = argrelextrema(df['low'].values, np.less, order=window)[0]

df.loc[high_idxs, 'swing_high'] = df['high'].iloc[high_idxs]
df.loc[low_idxs, 'swing_low'] = df['low'].iloc[low_idxs]

# ‚úÖ 3Ô∏è‚É£ Plot Trend Lines
plt.figure(figsize=(12, 6))
plt.plot(df['timestamp'], df['close'], label='Close Price', color='black', linewidth=1)

# Plot Swing Highs & Lows
plt.scatter(df['timestamp'], df['swing_high'], color='red', label='Swing Highs', marker='^')
plt.scatter(df['timestamp'], df['swing_low'], color='green', label='Swing Lows', marker='v')

plt.title(f'Trend Line Detection - {symbol}')
plt.xlabel('Date')
plt.ylabel('Price')
plt.legend()
plt.xticks(rotation=45)
plt.grid()

# ‚úÖ 4Ô∏è‚É£ Save Chart
plot_path = "/home/ubuntu/trend_lines.png"
plt.savefig(plot_path)
plt.close()

# ‚úÖ 5Ô∏è‚É£ Send Image to Telegram
TOKEN = "7619077339:AAGvLzsABJRFKsv50TgI1XxMNhVvtED-E_4"
CHAT_ID = "1385370555"

url = f"https://api.telegram.org/bot{TOKEN}/sendPhoto"
files = {"photo": open(plot_path, "rb")}
data = {"chat_id": CHAT_ID, "caption": "üìà Trend Line Analysis for BTC/USDT"}

response = requests.post(url, files=files, data=data)
print(response.json())  # Check Telegram API response