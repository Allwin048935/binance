import ccxt
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import requests
from scipy.signal import argrelextrema
from scipy.stats import linregress

# ‚úÖ 1Ô∏è‚É£ Fetch Data from Binance
exchange = ccxt.binance()
symbol = 'BTC/USDT'
timeframe = '4h'
limit = 500

ohlcv = exchange.fetch_ohlcv(symbol, timeframe, limit=limit)
df = pd.DataFrame(ohlcv, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')

# ‚úÖ 2Ô∏è‚É£ Identify Swing Highs and Lows (Using Local Extrema)
window = 10  # Larger window for trendline pattern detection
df['swing_high'] = np.nan
df['swing_low'] = np.nan

high_idxs = argrelextrema(df['high'].values, np.greater, order=window)[0]
low_idxs = argrelextrema(df['low'].values, np.less, order=window)[0]

df.loc[high_idxs, 'swing_high'] = df['high'].iloc[high_idxs]
df.loc[low_idxs, 'swing_low'] = df['low'].iloc[low_idxs]

# ‚úÖ 3Ô∏è‚É£ Detect Trendline Patterns with Multiple Swing Points
def get_trendline(x_vals, y_vals):
    """Fits a linear trendline to the given x and y points."""
    if len(x_vals) < 3:  # Need at least 3 points for better accuracy
        return None, None
    slope, intercept, _, _, _ = linregress(x_vals, y_vals)
    return slope, intercept

# Extract Swing Highs and Lows for Trendline Detection
swing_highs = df.dropna(subset=['swing_high'])
swing_lows = df.dropna(subset=['swing_low'])

# Function to find multiple trendlines in different segments
def find_multiple_trendlines(data, step=50):
    """Splits data into segments and finds trendlines in each."""
    trendlines = []
    for i in range(0, len(data) - step, step // 2):  # Overlapping windows
        segment = data.iloc[i:i+step]
        if len(segment) < 3:
            continue
        x_vals = segment.index.values
        y_vals = segment.values
        slope, intercept = get_trendline(x_vals, y_vals)
        if slope is not None:
            trendlines.append((x_vals, slope * x_vals + intercept))
    return trendlines

# Find multiple support and resistance trendlines
resistance_trendlines = find_multiple_trendlines(swing_highs['swing_high'])
support_trendlines = find_multiple_trendlines(swing_lows['swing_low'])

# ‚úÖ 4Ô∏è‚É£ Plot Trendlines and Detect Patterns
plt.figure(figsize=(12, 6))
plt.plot(df['timestamp'], df['close'], label='Close Price', color='black', linewidth=1)
plt.scatter(df['timestamp'], df['swing_high'], color='red', label='Swing Highs', marker='^')
plt.scatter(df['timestamp'], df['swing_low'], color='green', label='Swing Lows', marker='v')

# Plot multiple resistance trendlines
for x_vals, y_vals in resistance_trendlines:
    plt.plot(df['timestamp'].iloc[x_vals], y_vals, 'r--', label='Resistance')

# Plot multiple support trendlines
for x_vals, y_vals in support_trendlines:
    plt.plot(df['timestamp'].iloc[x_vals], y_vals, 'g--', label='Support')

plt.title(f'Trendline Pattern Detection - {symbol}')
plt.xlabel('Date')
plt.ylabel('Price')
plt.legend()
plt.xticks(rotation=45)
plt.grid()

# ‚úÖ 5Ô∏è‚É£ Save Chart
plot_path = "/home/ubuntu/trendline_patterns.png"
plt.savefig(plot_path)
plt.close()

# ‚úÖ 6Ô∏è‚É£ Send Image to Telegram
TOKEN = "7619077339:AAGvLzsABJRFKsv50TgI1XxMNhVvtED-E_4"
CHAT_ID = "1385370555"

url = f"https://api.telegram.org/bot{TOKEN}/sendPhoto"
files = {"photo": open(plot_path, "rb")}
data = {"chat_id": CHAT_ID, "caption": "üìà Multi-Segment Trendline Patterns for BTC/USDT"}

response = requests.post(url, files=files, data=data)
print(response.json())